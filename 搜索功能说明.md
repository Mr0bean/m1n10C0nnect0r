# Newsletter全文搜索功能说明

## 概述
已实现基于Elasticsearch的全文搜索功能，支持对存储在MinIO中的Newsletter文档进行关键词搜索、模糊匹配和高级过滤。

## 功能特性

### 1. 全文搜索
- 支持对文档标题、内容、HTML内容等所有文本字段进行搜索
- 智能权重分配：标题权重最高(3x)、内容(2x)、其他字段(1x)
- 自动纠错：支持模糊匹配，容忍拼写错误
- 短语匹配：支持短语前缀匹配，提高搜索准确度

### 2. 搜索高亮
- 自动在搜索结果中高亮显示匹配的关键词
- 使用`<mark>`标签标记匹配内容
- 支持多字段高亮(标题、内容等)

### 3. 高级过滤
- 按文档类型过滤
- 按文件大小范围过滤
- 支持分页(from/size参数)
- 多种排序方式(_score相关度/size文件大小)

## API端点

### 快速搜索
```
GET /api/v1/newsletter/search/quick?q=关键词
```

简化版搜索接口，只需输入关键词即可获得前10条最相关结果。

**示例:**
```bash
curl "http://localhost:9011/api/v1/newsletter/search/quick?q=AI"
```

### 完整搜索
```
GET /api/v1/newsletter/search/?query=关键词&from=0&size=20&sort_by=_score&highlight=true
```

支持完整的搜索参数配置。

**参数说明:**
- `query`: 搜索关键词
- `from`: 起始位置(用于分页)
- `size`: 返回数量(最大100)
- `sort_by`: 排序字段(_score/size)
- `highlight`: 是否高亮显示

**示例:**
```bash
curl "http://localhost:9011/api/v1/newsletter/search/?query=machine%20learning&from=0&size=10&sort_by=_score&highlight=true"
```

### 高级搜索(POST)
```
POST /api/v1/newsletter/search/advanced
```

通过POST请求体传递复杂搜索条件。

**请求体示例:**
```json
{
  "query": "AI",
  "article_type": "markdown",
  "min_wordcount": 500,
  "max_wordcount": 5000,
  "from": 0,
  "size": 20,
  "sort_by": "_score"
}
```

## 测试脚本

### 1. 直接测试搜索服务
```bash
python3 scripts/test_newsletter_search.py
```
测试搜索服务的各项功能，包括基本搜索、高级搜索、排序、分页等。

### 2. 测试API端点
```bash
# 启动后端服务
cd minio-file-manager/backend
python3 -m uvicorn app.main:app --reload --port 9011

# 运行API测试
python3 scripts/test_search_api.py
```

### 3. 查看ES索引详情
```bash
python3 scripts/show_es_details.py minio_documents
```

## 实现细节

### 文件结构
```
minio-file-manager/backend/
├── app/
│   ├── services/
│   │   └── newsletter_search_service.py  # 搜索服务实现
│   └── api/
│       └── endpoints/
│           └── newsletter_search.py      # API端点定义
scripts/
├── test_newsletter_search.py            # 搜索功能测试
├── test_search_api.py                   # API端点测试
└── show_es_details.py                   # ES索引查看工具
```

### 使用的ES索引
- **索引名**: `minio_documents`
- **文档数**: 180个文档
- **主要字段**:
  - `title`: 文档标题
  - `content`: 文档内容
  - `content_full`: 完整内容
  - `html_content`: HTML内容
  - `object_name`: 对象名称
  - `bucket_name`: 存储桶名称
  - `document_type`: 文档类型
  - `size`: 文件大小

### 搜索算法
1. **多字段匹配(Multi-Match)**
   - 同时搜索多个字段
   - 使用best_fields策略选择最佳匹配
   - 支持模糊匹配(fuzziness=AUTO)

2. **短语前缀匹配(Match Phrase Prefix)**
   - 提高短语搜索的准确性
   - 对标题和内容字段分别应用

3. **布尔查询(Bool Query)**
   - 使用should子句组合多个查询条件
   - minimum_should_match=1确保至少匹配一个条件

## 使用示例

### Python代码调用
```python
from app.services.newsletter_search_service import newsletter_search_service

# 基本搜索
result = await newsletter_search_service.search_articles(
    query="AI agent",
    from_=0,
    size=20,
    sort_by="_score",
    highlight=True
)

# 高级搜索
result = await newsletter_search_service.search_with_filters(
    query="machine learning",
    article_type="markdown",
    min_wordcount=1000,
    from_=0,
    size=10
)
```

### cURL命令示例
```bash
# 快速搜索
curl "http://localhost:9011/api/v1/newsletter/search/quick?q=transformer"

# 完整搜索
curl "http://localhost:9011/api/v1/newsletter/search/?query=neural%20network&size=5"

# 高级搜索
curl -X POST "http://localhost:9011/api/v1/newsletter/search/advanced" \
  -H "Content-Type: application/json" \
  -d '{"query":"AI","article_type":"markdown","size":10}'
```

## 注意事项

1. **索引问题**: 当前使用的是`minio_documents`索引，如果需要使用专门的`newsletter_articles`索引，需要先创建并导入数据。

2. **中文搜索**: 目前主要针对英文内容优化，中文搜索可能需要额外配置IK分词器。

3. **性能优化**: 
   - 默认返回20条结果，最大100条
   - 大内容字段(如content_full)被排除在搜索结果的_source中
   - 使用高亮时会增加响应时间

4. **错误处理**: 
   - 索引不存在时会返回明确的错误信息
   - 排序字段不存在时会自动回退到默认排序

## 后续优化建议

1. **添加更多过滤条件**
   - 日期范围过滤
   - 标签过滤
   - 作者过滤

2. **搜索优化**
   - 实现同义词扩展
   - 添加搜索建议(Suggest API)
   - 实现拼写纠正

3. **性能提升**
   - 添加搜索结果缓存
   - 实现搜索预热
   - 优化索引映射

4. **用户体验**
   - 添加搜索历史记录
   - 实现搜索结果导出
   - 添加搜索统计分析